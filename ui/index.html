<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <!-- Load required Bootstrap and BootstrapVue CSS -->
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap@4.5.3/dist/css/bootstrap.min.css" />
  <link type="text/css" rel="stylesheet" href="https://unpkg.com/bootstrap-vue@2.21.2/dist/bootstrap-vue.min.css" />
  
  <!-- Load polyfills to support older browsers -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es2015,IntersectionObserver" crossorigin="anonymous"></script>
  
  <!-- Load Vue followed by BootstrapVue -->
  <script src="https://unpkg.com/vue@2.6.14/dist/vue.js"></script>
  <script src="https://unpkg.com/bootstrap-vue@2.21.2/dist/bootstrap-vue.js"></script>
  
  <!-- Load the following for BootstrapVueIcons support -->
  <script src="https://unpkg.com/bootstrap-vue@latest/dist/bootstrap-vue-icons.min.js"></script>
  
  <script src="https://cdn.jsdelivr.net/npm/axios@0.12.0/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lodash@4.13.1/lodash.min.js"></script>
  
  <script src="https://unpkg.com/vue-infinite-scroll@2.0.2/vue-infinite-scroll.js"></script>
  
  <style>
    
    .background-image{
      background: radial-gradient(rgb(255 255 255 / 0%),rgb(0 0 0 / 72%)) ,linear-gradient(rgb(255 255 255 / 45%), rgb(255 255 255 / 45%)), url("images/bottles.jpg");
      background-size: cover;
      background-position: center center;
      background-attachment: fixed;
    }
    
    body {
      margin: 0;
      font-family: Roboto, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
      font-size: .8125rem;
      font-weight: 400;
      line-height: 1.5385;
      color: #333;
      text-align: left;
      background-color: #f5f5f5
    }
    
    .mt-50 {
      margin-top: 50px
    }
    
    .mb-50 {
      margin-bottom: 50px
    }
    
    .bg-teal-400 {
      background-color: #26a69a
    }
    
    a {
      text-decoration: none !important
    }
    
    .fa {
      color: red
    }
    
    .infinite-scroll-container{
      height: 89.6vh;
      overflow-y: scroll;
      -ms-overflow-style: none;  /* IE and Edge */
      scrollbar-width: none;  /* Firefox */
    }
    
    .infinite-scroll-container::-webkit-scrollbar {
      display: none;
    }
    
    
    
    
    
    .puff-in-center {
      -webkit-animation: puff-in-center 0.2s cubic-bezier(0.470, 0.000, 0.745, 0.715) both;
      animation: puff-in-center 0.2s cubic-bezier(0.470, 0.000, 0.745, 0.715) both;
    }
    /* ----------------------------------------------
    * Generated by Animista on 2021-6-28 20:11:1
    * Licensed under FreeBSD License.
    * See http://animista.net/license for more info. 
    * w: http://animista.net, t: @cssanimista
    * ---------------------------------------------- */
    
    /**
    * ----------------------------------------
    * animation puff-in-center
    * ----------------------------------------
    */
    @-webkit-keyframes puff-in-center {
      0% {
        -webkit-filter: blur(4px);
        filter: blur(4px);
        opacity: 0;
      }
      100% {
        -webkit-filter: blur(0px);
        filter: blur(0px);
        opacity: 1;
      }
    }
    @keyframes puff-in-center {
      0% {
        -webkit-filter: blur(4px);
        filter: blur(4px);
        opacity: 0;
      }
      100% {
        -webkit-filter: blur(0px);
        filter: blur(0px);
        opacity: 1;
      }
    }
    
    
  </style>
  
</head>

<body class="background-image">
  <div style="backdrop-filter: blur(5px); min-height: 100vh;">
    <div id="page-container"></div>
  </div>
  
  <template id="page-template">
    <div>
      <b-container>
        <b-navbar class="mb-3" style="background-color: #000000;border:2px solid white">
          
          <b-navbar-brand href="#">
            <img src="/images/logo.png" width="200" alt="">
          </b-navbar-brand>
          
          <b-navbar-toggle target="nav-collapse"></b-navbar-toggle>
          <br>
          <b-form-input size="md" class="mr-sm-2" placeholder="Malta, agua, lupulo...." v-model="query"></b-form-input>
        </b-navbar>
        <div id="results-div" class="infinite-scroll-container" :class="{'puff-in-center': show_animation }" v-infinite-scroll="getMoreItems" infinite-scroll-disabled="loading_more" infinite-scroll-distance="500">
          <b-card no-body v-for="item in items" :key="item._id" class="mb-3 item-card">
            <b-card-body>
              <div class="media align-items-center align-items-lg-start text-center text-lg-left flex-column flex-lg-row">
                <div class="mr-2 mb-3 mb-lg-0" style="flex: 0 0 150px;"> 
                  <b-img-lazy :src="item._source.img_url" height="150" alt=""> 
                  </div>
                  
                  <div class="media-body">
                    <h5 class="media-title font-weight-semibold"> <a :href="item._source.link">{{ item._source.name }}</a></h5>
                    <ul class="list-inline list-inline-dotted mb-3 mb-lg-2">
                      <li class="list-inline-item">
                        <img v-if="item._source.provider == 'imp'" src="https://www.impcerveceros.com.ar/web/image/website/1/logo/IMP%20Cerveceros" height="20" alt="IMP cerveceros">
                        <img v-if="item._source.provider == 'browers'" src="https://www.browersinsumos.com.ar/images/marca.png" height="20" alt="IMP cerveceros">
                      </li>
                      <li class="list-inline-item">
                        <span class="badge badge-pill badge-primary">{{ item._source.primary_category }}</span>
                      </li>
                      <li class="list-inline-item">
                        <span class="badge badge-pill badge-info">{{ item._source.secondary_category }}</span>
                      </li>
                    </ul>
                    <p class="mb-3">
                      {{ item._source.description }}
                    </p>
                  </div>
                  <div class="mt-3 mt-lg-0 ml-lg-3 text-center">
                    <h3 class="mb-0 font-weight-semibold">${{ item._source.price }}</h3>
                    <div>
                      <span v-if="item._source.in_stock == 'no'" class="badge badge-danger">Sin Stock</span>
                      <span v-if="item._source.in_stock == 'yes'" class="badge badge-success">En Stock</span>
                    </div>
                  </div>
                  
                </div>
              </b-card-body>
            </b-card>
          </div>
          
        </b-container>
      </div>
    </template>
    
    <script>
      let base_url = "http://" + window.location.hostname + ':8500';
      
      const app = new Vue({
        el: '#page-container',
        data: {
          query: "",
          items: null,
          total_items: null,
          current_last_item: null,
          loading_more: false,
          show_animation: false,
          providers: {
            imp: 'IMP cerveceros',
            browers: 'Browers insumos',
          }
        },
        template: '#page-template',
        created: function () {
          this.debouncedGetItems = _.debounce(this.getItems, 500)
        },
        watch: {
          // whenever question changes, this function will run
          query: function (new_query, old_query) {
            this.debouncedGetItems();
          }
        },
        mounted(){
          let query = new URLSearchParams(window.location.search).get('q')
          if (query != '' && query != null){
            this.query = query
            this.getItems();
          }
        },
        methods: {
          getItems: function () {
            var vm = this
            this.show_animation = true;
            this.hideAnimation();
            
            var results_div = document.getElementById('results-div');
            results_div.scrollTop = 0;
            
            addr = new URL(window.location.href);
            addr.searchParams.set('q', this.query);
            history.pushState('', '', addr.pathname + addr.search);
            
            query = {
              "query": {
                "multi_match": {
                  "query" : this.query,
                  "type": "phrase_prefix",
                  "fields": ["name^10", "primary_category^5", "secondary_category^5", "description"]
                }
              }
            }
            // console.log( JSON.stringify(query));
            axios.get(base_url + '/items/_search', 
            {
              params:{
                source: JSON.stringify(query),
                source_content_type: 'application/json'
              } 
              // data: JSON.stringify(query),
            })
            .then(function (response) {
              if (response && response.status == 200){
                vm.items = response.data.hits.hits
                vm.total_items = response.data.hits.total.value
                vm.current_last_item = vm.items.length;
              }
              console.log(response)
            })
            .catch(function (error) {
              vm.items = []
            })
          },
          getMoreItems(){
            if (this.current_last_item >= this.total_items) return;
            vm = this;
            this.loading_more = true;
            
            query = {
              "from": this.current_last_item,
              "size": 10,
              "query": {
                "multi_match": {
                  "query" : this.query,
                  "type": "phrase_prefix",
                  "fields": ["primary_category","name", "description"]
                }
              }
            }
            axios.get(base_url + '/items/_search', 
            {
              params:{
                source: JSON.stringify(query),
                source_content_type: 'application/json'
              } 
            })
            .then(function (response) {
              if (response && response.status == 200){
                console.log(response.data.hits.hits);
                vm.items = vm.items.concat(response.data.hits.hits);
                vm.current_last_item += response.data.hits.hits.length;
              }
              vm.loading_more = false
            })
            .catch(function (error) {
              this.loading_more = false;
            })
          },
          hideAnimation(){
            let vm = this
            setTimeout(function(){
              vm.show_animation = false;
            }, 400);
          }
        }
      });
    </script>
  </body>
  </html>